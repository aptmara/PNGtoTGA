<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>PNG to TGA Converter</title>
    <meta name="description" content="A high-performance, accessible, in-browser PNG to TGA converter with parallel processing and TGA preview.">
    <meta name="color-scheme" content="light dark">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root{--primary-color:#0d6efd;--success-color:#198754;--success-hover-color:#157347;--warning-bg-color:#fffbe6;--warning-border-color:#ffe58f;--warning-text-color:#d46b08;--info-bg-color:#e6f7ff;--info-text-color:#096dd9;--bg-color:#e9ecef;--card-bg-color:#fff;--text-color:#212529;--text-muted-color:#6c757d;--header-text-color:#343a40;--border-color:#dee2e6;--drop-zone-icon-color:#adb5bd;--stat-bg-color:#f8f9fa;--box-shadow:0 4px 6px rgba(0,0,0,.1);--font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;--border-radius:.5rem}
        @media (prefers-color-scheme:dark){:root{--primary-color:#409cff;--success-color:#20c997;--success-hover-color:#1baa80;--bg-color:#18191a;--card-bg-color:#242526;--text-color:#e4e6eb;--text-muted-color:#b0b3b8;--header-text-color:#e4e6eb;--border-color:#4d4f52;--drop-zone-icon-color:#8a8d91;--stat-bg-color:#3a3b3c;--box-shadow:0 4px 8px rgba(0,0,0,.3);--warning-bg-color:#4d3800;--warning-border-color:#7d5a00;--warning-text-color:#ffc107;--info-bg-color:#00376b;--info-text-color:#74c0fc}}
        *, *::before, *::after { box-sizing: border-box; }
        body{font-family:var(--font-family);background-color:var(--bg-color);color:var(--text-color);display:flex;justify-content:center;align-items:flex-start;padding:2rem;min-height:100vh;margin:0}
        .converter-container{width:100%;max-width:800px;display:grid;gap:1.5rem}
        .card{background-color:var(--card-bg-color);border-radius:var(--border-radius);box-shadow:var(--box-shadow);padding:1.5rem 2rem}
        .card-header{display:flex;align-items:center;margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:1px solid var(--border-color)}
        .card-header i{font-size:1.5rem;color:var(--primary-color);margin-right:1rem}
        .card-header h2{margin:0;font-size:1.5rem;color:var(--header-text-color)}
        #drop-zone{border:3px dashed var(--border-color);border-radius:var(--border-radius);padding:3rem;text-align:center;cursor:pointer;transition:background-color .2s,border-color .2s}
        #drop-zone.dragover{border-color:var(--primary-color);background-color:rgba(13,110,253,.1)}
        #drop-zone.disabled{cursor:not-allowed;background-color:var(--bg-color);opacity:.7}
        #drop-zone i{font-size:3rem;color:var(--drop-zone-icon-color);margin-bottom:1rem;pointer-events:none}
        #drop-zone p{margin:0;color:var(--text-muted-color);font-size:1.1rem;pointer-events:none}
        #file-input{display:none}
        .form-group{margin-bottom:1rem;display:flex;align-items:center;flex-wrap:wrap}
        .form-group label{font-weight:600;margin-right:.5rem}
        .form-group select,.form-group input[type=checkbox]{vertical-align:middle;margin-left:auto}
        .form-group select,.form-group input{padding:.5rem;border-radius:.25rem;border:1px solid var(--border-color);background-color:var(--card-bg-color);color:var(--text-color)}
        details{color:var(--text-color)}
        details summary{font-weight:600;cursor:pointer}
        #status-area{text-align:center;margin:1.5rem 0;min-height:40px}
        .spinner{border:4px solid rgba(128,128,128,.2);width:36px;height:36px;border-radius:50%;border-left-color:var(--primary-color);animation:spin 1s ease infinite;display:none;margin:0 auto}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        #progress-text{font-size:1.1em;color:var(--text-muted-color)}
        #results-area{display:none}
        #summary-text{font-weight:700;font-size:1.2em;text-align:center;padding:1rem;border-radius:var(--border-radius)}
        #summary-text.has-error{background-color:var(--warning-bg-color);color:var(--warning-text-color);border:1px solid var(--warning-border-color)}
        #summary-text.all-success{background-color:var(--info-bg-color);color:var(--info-text-color);border:1px solid var(--primary-color)}
        #error-log-area{margin-top:1rem;max-height:150px;overflow-y:auto}
        #error-log{list-style-type:none;padding:0;margin:0}
        #error-log li{background-color:var(--bg-color);padding:.75rem;border-radius:.25rem;margin-bottom:.5rem;font-family:monospace;font-size:.9em;color:var(--danger-color)}
        #stats-area{margin-top:1.5rem;padding-top:1.5rem;border-top:1px solid var(--border-color);display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;text-align:center}
        .stat-item{background-color:var(--stat-bg-color);padding:1rem;border-radius:.25rem}
        .stat-item i{font-size:1.5rem;color:var(--primary-color);margin-bottom:.5rem;display:block}
        .stat-label{font-size:.9em;color:var(--text-muted-color);margin-bottom:.25rem}
        .stat-value{font-size:1.2em;font-weight:700;color:var(--header-text-color)}
        #download-button-area{margin-top:1.5rem;text-align:center}
        #download-button{display:none;padding:.8rem 1.5rem;background-color:var(--success-color);color:#fff;text-decoration:none;border:none;border-radius:6px;font-size:1.2rem;font-weight:600;cursor:pointer;transition:background-color .2s}
        #download-button:hover{background-color:var(--success-hover-color)}
        #download-button i{margin-right:.5rem}
        /* --- Preview & Modal Styles --- */
        .checkerboard-bg{background-image:linear-gradient(45deg,#ccc 25%,transparent 25%),linear-gradient(-45deg,#ccc 25%,transparent 25%),linear-gradient(45deg,transparent 75%,#ccc 75%),linear-gradient(-45deg,transparent 75%,#ccc 75%);background-size:20px 20px;background-position:0 0,0 10px,10px -10px,-10px 0;background-color:#fff}
        @media (prefers-color-scheme:dark){.checkerboard-bg{background-image:linear-gradient(45deg,#444 25%,transparent 25%),linear-gradient(-45deg,#444 25%,transparent 25%),linear-gradient(45deg,transparent 75%,#444 75%),linear-gradient(-45deg,transparent 75%,#444 75%);background-color:#222}}
        #preview-area{margin-top:1.5rem;padding-top:1.5rem;border-top:1px solid var(--border-color)}
        #preview-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(128px,1fr));gap:1rem}
        .preview-item{position:relative;display:flex;flex-direction:column;align-items:center;background-color:var(--stat-bg-color);padding:.75rem;border-radius:.25rem;overflow:hidden}
        .preview-item canvas{max-width:100%;height:auto;border:1px solid var(--border-color);margin-bottom:.5rem;image-rendering:pixelated;cursor:pointer}
        .preview-item-label{font-size:.8em;color:var(--text-muted-color);text-align:center;word-break:break-all}
        .preview-download-link{position:absolute;top:.5rem;right:.5rem;color:var(--text-color);background-color:rgba(255,255,255,.7);border-radius:50%;width:28px;height:28px;display:flex;justify-content:center;align-items:center;text-decoration:none;transition:all .2s;opacity:.5}
        .preview-item:hover .preview-download-link{opacity:1}
        .preview-download-link:hover{background-color:rgba(255,255,255,1);color:var(--primary-color);transform:scale(1.1)}
        @media (prefers-color-scheme:dark){.preview-download-link{background-color:rgba(0,0,0,.5)}.preview-download-link:hover{background-color:rgba(0,0,0,.8)}}
        #modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:none;justify-content:center;align-items:center;z-index:1000;padding:1rem}
        .modal-content{position:relative;padding:20px;background:var(--card-bg-color);border-radius:var(--border-radius);max-width:95vw;max-height:95vh;display:flex;flex-direction:column;align-items:center}
        #modal-canvas{max-width:100%;max-height:calc(95vh - 80px);display:block;margin:0 auto;image-rendering:pixelated}
        #modal-caption{text-align:center;margin-top:1rem;font-weight:700;color:var(--header-text-color)}
        #modal-close-btn{position:absolute;top:10px;right:15px;font-size:2rem;color:var(--text-muted-color);cursor:pointer;line-height:1;transition:color .2s}
        #modal-close-btn:hover{color:var(--text-color)}
        :focus-visible{outline:3px solid var(--primary-color);outline-offset:2px}
        select:focus-visible,input:focus-visible,button:focus-visible{border-color:var(--primary-color)}
    </style>
</head>
<body>
    <main class="converter-container">
        <section class="card" aria-labelledby="header1">
            <header class="card-header">
                <i class="fas fa-file-arrow-up"></i>
                <h2 id="header1" data-i18n="header_selectFiles"></h2>
            </header>
            <div id="drop-zone" role="button" tabindex="0" aria-label="Select files to convert">
                <i class="fas fa-cloud-upload-alt"></i>
                <p data-i18n="dropZone_text"></p>
                <input type="file" id="file-input" accept="image/png" multiple>
            </div>
        </section>

        <section class="card" aria-labelledby="header2">
            <header class="card-header">
                <i class="fas fa-sliders-h"></i>
                <h2 id="header2" data-i18n="header_options"></h2>
            </header>
            <div class="form-group">
                <label for="preset-select" data-i18n="options_preset"></label>
                <select id="preset-select"></select>
            </div>
            <details open>
                <summary data-i18n="options_details"></summary>
                <div class="form-group form-switch" style="padding-top:1rem;">
                    <label for="flip-vertical-checkbox" data-i18n="options_flip"></label>
                    <input type="checkbox" id="flip-vertical-checkbox">
                </div>
            </details>
        </section>

        <section class="card" aria-labelledby="header3">
            <header class="card-header">
                 <i class="fas fa-chart-line"></i>
                <h2 id="header3" data-i18n="header_results"></h2>
            </header>
            <div id="status-area" aria-live="polite">
                <div id="spinner" class="spinner" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <p id="progress-text"></p>
            </div>
            <div id="results-area">
                <p id="summary-text"></p>
                <div id="stats-area"></div>
                <div id="preview-area" style="display:none;">
                    <h3 data-i18n="results_previews"></h3>
                    <div id="preview-grid"></div>
                </div>
                <div id="error-log-area" style="display:none;">
                    <h3 data-i18n="results_errorLog"></h3>
                    <ul id="error-log"></ul>
                </div>
            </div>
             <div id="download-button-area">
                <button id="download-button"><i class="fas fa-download"></i><span data-i18n="results_downloadBtn"></span></button>
            </div>
        </section>
    </main>

    <div id="modal-overlay">
        <div class="modal-content">
            <span id="modal-close-btn" role="button" aria-label="Close">&times;</span>
            <canvas id="modal-canvas" class="checkerboard-bg"></canvas>
            <div id="modal-caption"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        const ui = {
            dropZone: document.getElementById('drop-zone'), fileInput: document.getElementById('file-input'),
            presetSelect: document.getElementById('preset-select'), flipCheckbox: document.getElementById('flip-vertical-checkbox'),
            spinner: document.getElementById('spinner'), progressText: document.getElementById('progress-text'),
            resultsArea: document.getElementById('results-area'), summaryText: document.getElementById('summary-text'),
            statsArea: document.getElementById('stats-area'), errorLogArea: document.getElementById('error-log-area'),
            errorLog: document.getElementById('error-log'), downloadButton: document.getElementById('download-button'),
            previewArea: document.getElementById('preview-area'), previewGrid: document.getElementById('preview-grid'),
            previewHeader: document.querySelector('[data-i18n="results_previews"]'),
            modalOverlay: document.getElementById('modal-overlay'),
            modalCanvas: document.getElementById('modal-canvas'),
            modalCaption: document.getElementById('modal-caption'),
            modalCloseBtn: document.getElementById('modal-close-btn')
        };
        const numWorkers = navigator.hardwareConcurrency || 4;
        const SETTINGS_KEY = 'tgaConverterSettings_v1';
        let workerPool = [], isPoolReady = false, startTime, currentLang;
        let objectUrls = []; // To keep track of created object URLs for cleanup

        const locales = {
            ja: { appTitle: "PNG to TGA 変換ツール", header_selectFiles: "1. ファイルを選択", dropZone_text: "ここに複数のPNGファイルをドラッグ＆ドロップ<br>またはクリックしてファイルを選択", header_options: "2. 変換オプション", options_preset: "プリセット:", options_details: "詳細設定", options_flip: "画像を上下反転 (左下原点):", preset_custom: "カスタム", preset_game: "ゲームエンジン向け (Unity, Unreal Engine)", preset_graphics: "標準グラフィック向け (Photoshop互換)", header_results: "3. 実行と結果", results_previews: "プレビュー (クリックで拡大)", results_errorLog: "エラーログ:", results_downloadBtn: "ZIPファイルをダウンロード", status_initializing: `Workerを初期化中... ({count}/${numWorkers})`, status_ready: `準備完了 (${numWorkers}コア利用可能)。ファイルを選択してください。`, status_starting: "処理を開始しています...", status_processing: "変換中: {current} / {total}", status_zipping: "ZIPファイルを生成中...", status_downloadReady: "ダウンロードが開始されました。", summary_complete: "完了: {success}個成功, {error}個失敗", stats_totalTime: "総処理時間", stats_workers: "使用Worker数", stats_throughput: "スループット", stats_avgTime: "平均処理時間", alert_noPng: "変換可能なPNGファイルがありません。", alert_workerNotReady: "Workerが準備中です。", dropZone_aria: "変換するファイルを選択" },
            en: { appTitle: "PNG to TGA Converter", header_selectFiles: "1. Select Files", dropZone_text: "Drag & drop PNG files here<br>or click to select", header_options: "2. Conversion Options", options_preset: "Preset:", options_details: "Advanced Settings", options_flip: "Flip Image Vertically (Bottom-Left Origin):", preset_custom: "Custom", preset_game: "For Game Engines (Unity, Unreal Engine)", preset_graphics: "For Standard Graphics (Photoshop compatible)", header_results: "3. Execution & Results", results_previews: "Previews (Click to enlarge)", results_errorLog: "Error Log:", results_downloadBtn: "Download ZIP File", status_initializing: `Initializing Workers... ({count}/${numWorkers})`, status_ready: `Ready (${numWorkers} cores available). Please select files.`, status_starting: "Starting process...", status_processing: "Processing: {current} / {total}", status_zipping: "Generating ZIP file...", status_downloadReady: "Your download has started.", summary_complete: "Complete: {success} succeeded, {error} failed", stats_totalTime: "Total Time", stats_workers: "Workers Used", stats_throughput: "Throughput", stats_avgTime: "Avg. Time/File", alert_noPng: "No convertible PNG files found.", alert_workerNotReady: "Workers are not ready yet.", dropZone_aria: "Select files to convert" }
        };

        // --- Core Functions (Localization, Settings, Worker Pool) ---
        // (These functions remain largely unchanged from the previous version)
        function t(key, replacements = {}) {
            const langDict = locales[currentLang] || locales.en;
            let text = langDict[key] || locales.en[key] || key;
            for (const [placeholder, value] of Object.entries(replacements)) { text = text.replace(`{${placeholder}}`, value); }
            return text;
        }
        function applyLocale() {
            currentLang = navigator.language.startsWith('ja') ? 'ja' : 'en';
            document.documentElement.lang = currentLang;
            document.title = t('appTitle');
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.dataset.i18n;
                const html = t(key);
                if (el.innerHTML !== html) el.innerHTML = html;
            });
            ui.dropZone.setAttribute('aria-label', t('dropZone_aria'));
        }
        const presets = { custom: { nameKey: 'preset_custom' }, game: { nameKey: 'preset_game', options: { flip: true } }, graphics: { nameKey: 'preset_graphics', options: { flip: false } } };
        function saveSettings() { const s = { preset: ui.presetSelect.value, flip: ui.flipCheckbox.checked }; localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)); }
        function loadSettings() { const s = localStorage.getItem(SETTINGS_KEY); if(s){try{const p=JSON.parse(s);ui.presetSelect.value=p.preset||'game';if(p.preset==='custom'){ui.flipCheckbox.checked=p.flip;}else{applyPreset();}}catch(e){applyPreset();}}else{ui.presetSelect.value='game';applyPreset();} }
        function populatePresets() { ui.presetSelect.innerHTML = ''; for (const key in presets) { const o = document.createElement('option'); o.value = key; o.textContent = t(presets[key].nameKey); ui.presetSelect.appendChild(o); } }
        function applyPreset() { const p = presets[ui.presetSelect.value]; if (p && p.options) { ui.flipCheckbox.checked = p.options.flip; } }
        function enableDropZone(isEnabled) { if (isEnabled) { ui.dropZone.classList.remove('disabled'); ui.dropZone.onclick = () => ui.fileInput.click(); } else { ui.dropZone.classList.add('disabled'); ui.dropZone.onclick = null; } }
        async function initializeWorkerPool() {
            ui.progressText.textContent = t('status_initializing', { count: 0, total: numWorkers });
            let readyCount = 0;
            const promises = Array.from({ length: numWorkers }, () => new Promise(resolve => {
                const worker = new Worker('converter-worker.js');
                worker.onmessage = e => { if (e.data.type === 'ready') { readyCount++; ui.progressText.textContent = t('status_initializing', { count: readyCount, total: numWorkers }); resolve(worker); } };
                workerPool.push(worker);
            }));
            await Promise.all(promises);
            isPoolReady = true;
            enableDropZone(true);
            ui.progressText.textContent = t('status_ready');
        }

        // --- File Handling & Conversion ---
        async function handleFiles(files) {
            if (!isPoolReady) { alert(t('alert_workerNotReady')); return; }
            const pngFiles = Array.from(files).filter(f => f.type === 'image/png');
            if (pngFiles.length === 0) { alert(t('alert_noPng')); return; }

            startTime = performance.now();
            resetUI();
            enableDropZone(false);
            ui.spinner.style.display = 'block';
            ui.progressText.textContent = t('status_starting');

            const options = { alignToBottomLeft: ui.flipCheckbox.checked };
            const totalFiles = pngFiles.length;
            let processedCount = 0, allSuccessResults = [], allErrorResults = [];
            const filesPerWorker = Math.ceil(totalFiles / numWorkers);
            const workerPromises = [];

            for (let i = 0; i < numWorkers; i++) {
                const worker = workerPool[i];
                const chunk = pngFiles.slice(i * filesPerWorker, (i + 1) * filesPerWorker);
                if (chunk.length > 0) {
                    workerPromises.push(new Promise(resolve => {
                        worker.onmessage = e => {
                            const { type, ...data } = e.data;
                            if (type === 'file_processed') {
                                processedCount++;
                                ui.progressText.textContent = t('status_processing', { current: processedCount, total: totalFiles });
                            } else if (type === 'task_complete') {
                                allSuccessResults.push(...data.results);
                                allErrorResults.push(...data.errors);
                                resolve();
                            }
                        };
                        worker.postMessage({ files: chunk, options });
                    }));
                }
            }
            await Promise.all(workerPromises);
            showFinalSummary(allSuccessResults, allErrorResults, totalFiles);
        }

        // --- TGA Parsing and Rendering ---
        function parseAndRenderTga(tgaBuffer, targetCanvas) {
            const header = new DataView(tgaBuffer, 0, 18);
            if (header.getUint8(2) !== 2 || header.getUint8(16) !== 32) {
                console.error("Preview only supports 32-bit uncompressed TGA."); return null;
            }
            const width = header.getUint16(12, true);
            const height = header.getUint16(14, true);
            const imageDescriptor = header.getUint8(17);
            const isOriginTopLeft = (imageDescriptor & 0x20) === 0x20;
            const pixelDataOffset = 18 + header.getUint8(0);
            const bgra = new Uint8Array(tgaBuffer, pixelDataOffset);

            const canvas = targetCanvas || document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            const imageData = ctx.createImageData(width, height);
            const rgba = imageData.data;

            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const srcY = isOriginTopLeft ? y : height - 1 - y;
                    const srcIndex = (srcY * width + x) * 4;
                    const destIndex = (y * width + x) * 4;
                    rgba[destIndex]     = bgra[srcIndex + 2]; // R
                    rgba[destIndex + 1] = bgra[srcIndex + 1]; // G
                    rgba[destIndex + 2] = bgra[srcIndex];     // B
                    rgba[destIndex + 3] = bgra[srcIndex + 3]; // A
                }
            }
            ctx.putImageData(imageData, 0, 0);
            return canvas;
        }

        // --- UI Update and Results Display ---
        function showFinalSummary(successes, errors, totalFiles) {
            const totalTimeSeconds = ((performance.now() - startTime) / 1000);
            ui.spinner.style.display = 'none';
            ui.progressText.textContent = '';
            ui.resultsArea.style.display = 'block';
            ui.summaryText.textContent = t('summary_complete', { success: successes.length, error: errors.length });
            ui.summaryText.className = errors.length > 0 ? 'has-error' : 'all-success';

            const stats = { [t('stats_totalTime')]:{value:`${totalTimeSeconds.toFixed(2)} s`,icon:"fa-solid fa-stopwatch"}, [t('stats_workers')]:{value:`${numWorkers} Cores`,icon:"fa-solid fa-microchip"}, [t('stats_throughput')]:{value:`${(totalFiles/totalTimeSeconds).toFixed(2)} files/s`,icon:"fa-solid fa-gauge-high"}, [t('stats_avgTime')]:{value:`${(totalTimeSeconds/totalFiles*1000).toFixed(0)} ms/file`,icon:"fa-solid fa-clock-rotate-left"} };
            ui.statsArea.innerHTML = Object.entries(stats).map(([l, {v, i}]) => `<div class="stat-item"><i class="${i}"></i><div class="stat-label">${l}</div><div class="stat-value">${v}</div></div>`).join('');

            if (errors.length > 0) {
                ui.errorLogArea.style.display = 'block';
                ui.errorLog.innerHTML = errors.map(err => `<li><i class="fas fa-exclamation-triangle"></i> ${err.filename}: ${err.reason}</li>`).join('');
            }

            if (successes.length > 0) {
                ui.previewArea.style.display = 'block';
                ui.previewHeader.style.display = 'block';
                successes.forEach(result => {
                    const canvas = parseAndRenderTga(result.buffer);
                    if (canvas) {
                        canvas.classList.add('checkerboard-bg');
                        
                        const item = document.createElement('div');
                        item.className = 'preview-item';
                        
                        // Show modal on click
                        canvas.addEventListener('click', () => {
                            parseAndRenderTga(result.buffer, ui.modalCanvas);
                            ui.modalCaption.textContent = `${result.filename} (${canvas.width}x${canvas.height})`;
                            ui.modalOverlay.style.display = 'flex';
                        });

                        // Individual download link
                        const downloadLink = document.createElement('a');
                        downloadLink.className = 'preview-download-link';
                        downloadLink.innerHTML = '<i class="fas fa-download"></i>';
                        downloadLink.title = `Download ${result.filename}`;
                        const tgaBlob = new Blob([result.buffer], { type: 'application/octet-stream' });
                        const url = URL.createObjectURL(tgaBlob);
                        objectUrls.push(url); // Track URL for later cleanup
                        downloadLink.href = url;
                        downloadLink.download = result.filename;
                        downloadLink.addEventListener('click', e => e.stopPropagation()); // Prevent modal from opening

                        const label = document.createElement('div');
                        label.className = 'preview-item-label';
                        label.textContent = result.filename;

                        item.appendChild(canvas);
                        item.appendChild(label);
                        item.appendChild(downloadLink);
                        ui.previewGrid.appendChild(item);
                    }
                });
                const btnText = ui.downloadButton.querySelector('span');
                btnText.textContent = t('results_downloadBtn');
                ui.downloadButton.style.display = 'block';
                ui.downloadButton.onclick = () => generateZip(successes);
            }
            enableDropZone(true);
        }

        async function generateZip(results) {
            ui.progressText.textContent = t('status_zipping');
            ui.downloadButton.disabled = true;
            const zip = new JSZip();
            for (const result of results) { zip.file(result.filename, result.buffer); }
            const zipBlob = await zip.generateAsync({ type: "blob" });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(zipBlob);
            link.download = `converted_tga_${Date.now()}.zip`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
            ui.progressText.textContent = t('status_downloadReady');
            ui.downloadButton.disabled = false;
        }

        function resetUI() {
            // Clean up old object URLs to prevent memory leaks
            objectUrls.forEach(url => URL.revokeObjectURL(url));
            objectUrls = [];

            ui.spinner.style.display = 'none';
            ui.progressText.textContent = '';
            ui.resultsArea.style.display = 'none';
            ui.errorLogArea.style.display = 'none';
            ui.errorLog.innerHTML = '';
            ui.downloadButton.style.display = 'none';
            ui.statsArea.innerHTML = '';
            ui.previewArea.style.display = 'none';
            ui.previewGrid.innerHTML = '';
            ui.previewHeader.style.display = 'none';
        }
        
        // --- Event Listeners and Initialization ---
        function setupEventListeners() {
            ui.presetSelect.addEventListener('change', () => { applyPreset(); saveSettings(); });
            ui.flipCheckbox.addEventListener('change', () => { ui.presetSelect.value = 'custom'; saveSettings(); });
            ui.fileInput.addEventListener('change', e => handleFiles(e.target.files));
            ui.dropZone.addEventListener('keydown', e => { if (isPoolReady && (e.key === 'Enter' || e.key === ' ')) { e.preventDefault(); ui.fileInput.click(); } });
            ui.dropZone.addEventListener('dragover', e => { e.preventDefault(); if (!ui.dropZone.classList.contains('disabled')) ui.dropZone.classList.add('dragover'); });
            ui.dropZone.addEventListener('dragleave', e => { e.preventDefault(); ui.dropZone.classList.remove('dragover'); });
            ui.dropZone.addEventListener('drop', e => { e.preventDefault(); ui.dropZone.classList.remove('dragover'); if (!ui.dropZone.classList.contains('disabled')) handleFiles(e.dataTransfer.files); });

            // Modal listeners
            const closeModal = () => { ui.modalOverlay.style.display = 'none'; };
            ui.modalCloseBtn.addEventListener('click', closeModal);
            ui.modalOverlay.addEventListener('click', e => { if (e.target === ui.modalOverlay) closeModal(); });
            document.addEventListener('keydown', e => { if (e.key === 'Escape' && ui.modalOverlay.style.display !== 'none') closeModal(); });
        }

        function initializeApp() {
            applyLocale();
            populatePresets();
            initializeWorkerPool();
            setupEventListeners();
            loadSettings();
        }

        initializeApp();
    </script>
</body>
</html>